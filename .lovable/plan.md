

## 청크 내용 검증 강화 + 모델 업그레이드

### 문제 원인

현재 검증은 **태그 수**만 비교합니다. "were obviously 'hunting the shadow,'" 같은 구절이 통째로 빠져도, 영어/한국어 태그 수가 둘 다 같으면 검증을 통과합니다.

### 해결 방법 (2가지 동시 적용)

---

### 변경 1: 원문 복원 검증 추가

영어 청크들을 이어붙인 결과가 **원래 문장과 동일한지** 확인하는 내용 검증을 추가합니다.

**검증 흐름:**

```text
AI 응답 수신
  |
  v
1. 태그 수 비교 (영어 == 한국어?)  --- No ---> 재시도
  |
  Yes
  v
2. 내용 복원 비교 (청크 합치면 원문과 같나?)  --- No ---> 재시도
  |
  Yes
  v
통과, 결과 반환
```

**추가할 헬퍼 함수:**
- `extractText(tagged)`: 모든 태그를 제거하고 텍스트만 추출
- `normalize(text)`: 공백 정규화 후 비교

**재시도 시 피드백:**
- 내용 누락일 때: "원문에서 빠진 부분이 있다. 모든 단어를 포함해라"는 구체적 피드백 제공

---

### 변경 2: 모델을 gemini-2.5-pro로 업그레이드

| 항목 | 현재 (gemini-3-flash-preview) | 변경 후 (gemini-2.5-pro) |
|------|-------------------------------|--------------------------|
| 정확도 | 빠르지만 복잡한 문장에서 누락 발생 | 추론 능력이 강해 누락 가능성 낮음 |
| 속도 | 빠름 | 약간 느림 (문장당 1-3초 추가) |
| 컨텍스트 | 충분 | 100만 토큰 (더 여유) |

복잡한 문장 구조(접속사, 인용구 등)에서 gemini-2.5-pro가 훨씬 안정적입니다. 속도는 문장당 1-3초 정도 더 걸릴 수 있지만, 재시도 없이 한 번에 정확한 결과를 받을 확률이 높아져서 오히려 전체 처리 시간은 비슷하거나 빨라질 수 있습니다.

---

### 수정 파일

| 파일 | 변경 내용 |
|------|----------|
| supabase/functions/engine/index.ts | 1. `extractText()`, `normalize()` 헬퍼 함수 추가<br>2. 검증 조건에 원문 복원 비교 추가<br>3. 내용 누락 시 구체적 재시도 피드백 추가<br>4. 모델을 `google/gemini-2.5-pro`로 변경 |

